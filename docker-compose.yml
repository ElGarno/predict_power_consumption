services:
  solar-prediction:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    container_name: solar-power-prediction
    restart: unless-stopped

    # Environment variables (loaded via Portainer or .env file if present)
    # Override specific settings for container
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATA_DIR=/usr/src/app/data
      - POLARS_SKIP_CPU_CHECK=1

      # Scheduling mode (daily is recommended for NAS)
      - PREDICTION_MODE=${PREDICTION_MODE:-daily}
      - DAILY_PREDICTION_HOUR=${DAILY_PREDICTION_HOUR:-21}
      - DAILY_PREDICTION_MINUTE=${DAILY_PREDICTION_MINUTE:-0}

      # Weekly model retraining (enabled by default)
      - MODEL_RETRAIN_ENABLED=${MODEL_RETRAIN_ENABLED:-true}
      - MODEL_RETRAIN_DAY=${MODEL_RETRAIN_DAY:-0}
      - MODEL_RETRAIN_HOUR=${MODEL_RETRAIN_HOUR:-3}
      - MODEL_RETRAIN_MINUTE=${MODEL_RETRAIN_MINUTE:-0}

      # Credentials from Portainer (loaded externally)
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_URL=${INFLUXDB_URL:-http://localhost:8086}
      - PUSHOVER_TAPO_API_TOKEN=${PUSHOVER_TAPO_API_TOKEN}
      - PUSHOVER_USER_GROUP_WOERIS=${PUSHOVER_USER_GROUP_WOERIS}

    # Persist data between container restarts (using named volumes)
    volumes:
      - solar-data:/usr/src/app/data
      - solar-logs:/usr/src/app/logs

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Graceful shutdown
    stop_grace_period: 30s

    # Network mode (use host for InfluxDB on same machine)
    network_mode: bridge

# Named volumes for persistent data
volumes:
  solar-data:
  solar-logs:

# Optional: InfluxDB service for local development
# Uncomment if you want to run InfluxDB locally for testing
#  influxdb:
#    image: influxdb:2.7-alpine
#    container_name: influxdb-local
#    restart: unless-stopped
#    ports:
#      - "8086:8086"
#    volumes:
#      - influxdb-data:/var/lib/influxdb2
#      - influxdb-config:/etc/influxdb2
#    environment:
#      - DOCKER_INFLUXDB_INIT_MODE=setup
#      - DOCKER_INFLUXDB_INIT_USERNAME=admin
#      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
#      - DOCKER_INFLUXDB_INIT_ORG=None
#      - DOCKER_INFLUXDB_INIT_BUCKET=power_consumption
#      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=your-super-secret-auth-token

#  influxdb-data:
#  influxdb-config:
